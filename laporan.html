<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Penjualan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f7f7f7;
      padding: 30px;
    }
    .card {
      max-width: 1100px;
      margin: auto;
      border-radius: 1rem;
      padding: 2rem;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .total {
      font-size: 1.2rem;
      font-weight: bold;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<div class="card">
  <h3 class="mb-4 text-center">üìã Laporan Penjualan</h3>

  <div class="row g-3 mb-4 no-print">
    <div class="col-md-4">
      <label for="filterTanggal" class="form-label">Filter Tanggal (YYYY-MM-DD)</label>
      <input type="date" id="filterTanggal" class="form-control">
    </div>
    <div class="col-md-4">
      <label for="filterBulan" class="form-label">Filter Bulan</label>
      <select id="filterBulan" class="form-select">
        <option value="">Semua Bulan</option>
      </select>
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="filterLaporan()">üîç Tampilkan</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>Tanggal</th>
          <th>Nama Obat</th>
          <th>Jumlah</th>
          <th>Total (Rp)</th>
        </tr>
      </thead>
      <tbody id="tabelLaporan"></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <a href="index.html" class="btn btn-secondary no-print">‚Üê Kembali</a>
    <div class="total">Total Penjualan: Rp <span id="totalPenjualan">0</span></div>
    <button class="btn btn-success no-print" onclick="window.print()">üñ® Cetak</button>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbzjOpnBZb_wGEOMrahiOdzxgXXWCuFanw0B7Gryq3cnwGNYNc742qiO93R0xsDSUraM/exec"; // Ganti dengan URL Web App kamu
let allData = [];

async function loadLaporan() {
  try {
    const res = await fetch(`${scriptURL}?action=getPenjualan`);
    const data = await res.json();
    allData = data.slice(1); // skip header

    // Isi dropdown bulan unik
    const bulanSet = new Set();
    allData.forEach(row => {
      const tgl = new Date(row[0]);
      const bulan = tgl.toLocaleString("default", { month: "long", year: "numeric" });
      bulanSet.add(bulan);
    });

    const filterBulan = document.getElementById("filterBulan");
    filterBulan.innerHTML = `<option value="">Semua Bulan</option>`;
    Array.from(bulanSet).forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      filterBulan.appendChild(opt);
    });

    tampilkanLaporan(allData);
  } catch (err) {
    alert("Gagal memuat data.");
    console.error(err);
  }
}

function tampilkanLaporan(data) {
  const tbody = document.getElementById("tabelLaporan");
  const totalEl = document.getElementById("totalPenjualan");
  tbody.innerHTML = "";
  let total = 0;

  data.forEach(row => {
    const tgl = new Date(row[0]);
    const nama = row[1];
    const jumlah = row[2];
    const totalRow = parseInt(row[3]);
    total += totalRow;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${tgl.toLocaleString()}</td>
      <td>${nama}</td>
      <td>${jumlah}</td>
      <td>Rp ${totalRow.toLocaleString("id-ID")}</td>
    `;
    tbody.appendChild(tr);
  });

  totalEl.textContent = total.toLocaleString("id-ID");
}

function filterLaporan() {
  const tanggalInput = document.getElementById("filterTanggal").value;
  const bulanInput = document.getElementById("filterBulan").value;

  const filtered = allData.filter(row => {
    const tgl = new Date(row[0]);
    const tglStr = tgl.toISOString().split("T")[0];
    const bulanStr = tgl.toLocaleString("default", { month: "long", year: "numeric" });

    if (tanggalInput && tglStr !== tanggalInput) return false;
    if (bulanInput && bulanStr !== bulanInput) return false;
    return true;
  });

  tampilkanLaporan(filtered);
}

loadLaporan();
</script>

</body>
</html>
